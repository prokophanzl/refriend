<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- favicon -->
		<link rel="apple-touch-icon" href="assets/png/icon.png" />
		<link rel="icon" type="image/png" href="assets/png/icon.png" />
		<link rel="icon" type="image/png" href="assets/png/icon.png" />

		<title>Refriend</title>
		<link rel="stylesheet" href="assets/css/compiled/style.css" />
		<link rel="stylesheet" href="assets/css/compiled/new_friend.css" />

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet" />
	</head>

	<body>
		<header>
			<div class="title-container">
				<span class="title"><a href="./">Refriend</a></span>
			</div>
			<div class="icon-container">
				<div class="icon account" id="account-button"></div>
			</div>
		</header>

		<main>
			<h2>Who did you see?</h2>
			<div class="input-container friend-name">
				<select id="friend-select">
					<option value="">Select a friend...</option>
				</select>
			</div>

			<h2>When did you see them?</h2>
			<div class="input-container last-met">
				<input type="date" />
			</div>

			<div class="button-container">
				<button onclick="window.location.href='./'">Cancel</button>
				<button>Log Hangout</button>
			</div>
		</main>

		<footer>made with <img src="assets/svg/heart.svg" alt="love" /> by <a href="https://github.com/prokophanzl">ash han≈æl</a></footer>

		<script type="module" src="assets/js/supabaseClient.js"></script>
		<script type="module" src="assets/js/auth.js"></script>

		<script type="module">
			import { requireAuth } from "./assets/js/auth.js";

			await requireAuth();
		</script>

		<script>
			// new_hangout.js
			document.addEventListener("DOMContentLoaded", async () => {
				const { data: userData } = await window.supabase.auth.getUser();
				const user = userData?.user;
				if (!user) return (window.location.href = "/login.html");

				const select = document.getElementById("friend-select");
				const dateInput = document.querySelector('.input-container.last-met input[type="date"]');
				const addBtn = document.querySelector(".button-container button:last-child");
				const cancelBtn = document.querySelector(".button-container button:first-child");

				// fetch friends
				const { data: friends, error } = await window.supabase
					.from("friends")
					.select("id,name")
					.eq("user_id", user.id)
					.order("name", { ascending: true });

				if (error) {
					console.error(error);
					return (select.innerHTML = '<option value="">Error loading friends</option>');
				}

				friends.forEach((f) => {
					const opt = document.createElement("option");
					opt.value = f.id;
					opt.textContent = f.name;
					select.appendChild(opt);
				});

				cancelBtn.addEventListener("click", () => (window.location.href = "/"));

				addBtn.addEventListener("click", async (ev) => {
					ev.preventDefault();
					const friendId = select.value;
					const date = dateInput.value;
					if (!friendId || !date) return alert("Pick friend and date");

					const { error: insErr } = await window.supabase.from("hangouts").insert([{ user_id: user.id, friend_id: friendId, date }]);

					if (insErr) {
						console.error(insErr);
						return alert("Failed to log hangout");
					}

					window.location.href = `/friend.html?id=${friendId}`;
				});
			});
		</script>

		<script type="module" src="assets/js/account_menu.js"></script>
	</body>
</html>
