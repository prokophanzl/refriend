<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- favicon -->
		<link rel="apple-touch-icon" href="assets/png/icon.png" />
		<link rel="icon" type="image/png" href="assets/png/icon.png" />
		<link rel="icon" type="image/png" href="assets/png/icon.png" />

		<title>Refriend</title>
		<link rel="stylesheet" href="assets/css/compiled/style.css" />
		<link rel="stylesheet" href="assets/css/compiled/new_friend.css" />

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet" />
	</head>
	<body>
		<header>
			<div class="title-container">
				<span class="title"><a href="./">Refriend</a></span>
			</div>
			<div class="icon-container">
				<div class="icon account" id="account-button"></div>
			</div>
		</header>

		<main>
			<h2>What's your friend's name?</h2>
			<div class="input-container friend-name">
				<input type="text" />
			</div>

			<h2>Would you like to upload a picture?</h2>
			<div class="input-container friend-name">
				<input type="file" />
			</div>

			<h2>How often would you like to see them?</h2>
			<div class="input-container hangout-goal">Every <input type="number" /> days.</div>

			<h2>When's the last time you saw them?</h2>
			<div class="input-container last-met">
				<input type="date" />
			</div>

			<div class="button-container">
				<button onclick="window.location.href='./'">Cancel</button>
				<button>Add Friend</button>
			</div>
		</main>

		<footer>made with <img src="assets/svg/heart.svg" alt="love" /> by <a href="https://github.com/prokophanzl">ash han≈æl</a></footer>

		<script type="module" src="assets/js/supabaseClient.js"></script>
		<script type="module" src="assets/js/auth.js"></script>

		<script type="module">
			import { requireAuth } from "./assets/js/auth.js";

			await requireAuth();
		</script>

		<script>
			// new_friend.js
			document.addEventListener("DOMContentLoaded", async () => {
				const userRes = await window.supabase.auth.getUser();
				const user = userRes?.data?.user;
				if (!user) {
					window.location.href = "/login.html";
					return;
				}

				const nameInput = document.querySelector('.input-container.friend-name input[type="text"]');
				const fileInput = document.querySelector('.input-container.friend-name input[type="file"]');
				const goalInput = document.querySelector('.input-container.hangout-goal input[type="number"]');
				const dateInput = document.querySelector('.input-container.last-met input[type="date"]');
				const addBtn = document.querySelector(".button-container button:last-child");
				const cancelBtn = document.querySelector(".button-container button:first-child");

				cancelBtn.addEventListener("click", () => (window.location.href = "/"));

				addBtn.addEventListener("click", async (e) => {
					e.preventDefault();
					const name = nameInput.value.trim();
					if (!name) return alert("Please enter a name");

					let avatar_url = null;
					const file = fileInput.files[0];
					if (file) {
						const path = `${user.id}/${Date.now()}_${file.name}`;
						const { data, error } = await window.supabase.storage
							.from("avatars")
							.upload(path, file, { cacheControl: "3600", upsert: false });

						if (error) {
							console.error("Upload error", error);
							return alert("Failed to upload avatar");
						}

						const { data: publicData } = window.supabase.storage.from("avatars").getPublicUrl(path);
						avatar_url = publicData.publicUrl;
					}

					const hangout_goal = parseInt(goalInput.value || "0", 10);
					const lastMet = dateInput.value || null;

					// insert friend
					const { data: friendData, error: friendError } = await window.supabase
						.from("friends")
						.insert([
							{
								user_id: user.id,
								name,
								hangout_goal,
								pinned: false,
								avatar_url,
								tags: [],
							},
						])
						.select()
						.single();

					if (friendError) {
						console.error("Insert friend error", friendError);
						return alert("Failed to add friend");
					}

					// if lastMet provided, log a hangout
					if (lastMet) {
						const { error: hangErr } = await window.supabase.from("hangouts").insert([
							{
								user_id: user.id,
								friend_id: friendData.id,
								date: lastMet,
							},
						]);
						if (hangErr) console.warn("Could not log initial hangout", hangErr);
					}

					window.location.href = "/";
				});
			});
		</script>

		<script type="module" src="assets/js/account_menu.js"></script>
	</body>
</html>
